name: Veracode Fix (Pipeline Scan â†’ Auto PR)

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pipeline_scan_and_fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Package your source (adjust build steps as needed)
      - name: Create source zip (exclude node_modules)
        run: |
          zip -r pipeline-src.zip . -x "**/node_modules/**" -x "**/.git/**"

      # 2) Setup Java for pipeline scan tool
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Download pipeline scan
      - name: Download Pipeline Scan tool
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      # 4) Run pipeline scan and emit results.json
      - name: Run Veracode Pipeline Scan (generate results.json)
        continue-on-error: true
        run: |
          java -jar pipeline-scan.jar \
            --veracode_api_id "${{ secrets.VID }}" \
            --veracode_api_key "${{ secrets.VKEY }}" \
            --file "pipeline-src.zip" \
            --esd true \
            --json_output_file "results.json"

      # 5) Run Veracode Fix GitHub Action (batch + PR)
      - name: Veracode Fix (batch PR)
        uses: veracode/veracode-fix-github-action@v1
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          inputFile: results.json
          language: java
          fixType: batch
          files: changed
          prComment: true
          createPR: true
