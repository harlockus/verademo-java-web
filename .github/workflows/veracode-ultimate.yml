name: Veracode Ultimate (Pipeline Scan + SARIF + Fix Universal)

on:
  workflow_dispatch:
    inputs:
      run_fix:
        description: "Run Veracode Fix (batch PR) after scan"
        required: true
        default: "true"
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  pull-requests: write
  actions: read
  security-events: write

jobs:
  pipeline_scan_and_sarif:
    if: github.event_name != 'pull_request' || !startsWith(github.head_ref, 'veracode-single-fix-holder-')
    runs-on: ubuntu-latest
    outputs:
      has_results: ${{ steps.scan_outputs.outputs.has_results }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure placeholder file exists (SARIF)
        run: |
          mkdir -p .veracode
          cat > .veracode/PIPELINE_SCAN_GLOBAL_FINDINGS.md << 'EOF'
          # Veracode Pipeline Scan – Global Findings Placeholder
          Findings without a resolvable repo file+line are anchored here.
          EOF

      - name: Create source zip (exclude node_modules)
        run: |
          zip -r pipeline-src.zip . -x "**/node_modules/**" -x "**/.git/**"

      - name: Set up Java (Pipeline Scan tool)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Pipeline Scan tool
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Run Pipeline Scan (ESD enabled, do not fail job on findings)
        id: scan_outputs
        env:
          VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}
        run: |
          set -euo pipefail

          set +e
          java -jar pipeline-scan.jar \
            -vid "${VERACODE_API_ID}" \
            -vkey "${VERACODE_API_KEY}" \
            -f "pipeline-src.zip" \
            -esd true \
            -jf "results.json" \
            -fjf "filtered_results.json"
          RC=$?
          set -e

          echo "Pipeline Scan exit code: $RC"
          ls -lah results.json filtered_results.json || true

          if [ -f results.json ] && [ -f filtered_results.json ]; then
            echo "has_results=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_results=false" >> "$GITHUB_OUTPUT"
            echo "ERROR: Pipeline Scan did not produce results.json / filtered_results.json"
            exit 1
          fi

      - name: Setup Python (SARIF conversion)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Convert Pipeline JSON -> SARIF
        run: |
          python scripts/pipeline_results_to_sarif.py \
            --input filtered_results.json \
            --output veracode-pipeline.sarif \
            --placeholder-uri .veracode/PIPELINE_SCAN_GLOBAL_FINDINGS.md \
            --output-stats veracode-pipeline-sarif-stats.json

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: veracode-pipeline.sarif
          category: veracode-pipeline
          wait-for-processing: true

      - name: Upload pipeline artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-pipeline-scan
          path: |
            results.json
            filtered_results.json
            veracode-pipeline.sarif
            veracode-pipeline-sarif-stats.json
            .veracode/PIPELINE_SCAN_GLOBAL_FINDINGS.md

  build_fix_matrix:
    needs: pipeline_scan_and_sarif
    if: needs.pipeline_scan_and_sarif.outputs.has_results == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}

    steps:
      - name: Setup Python (matrix builder)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Fix matrix (single-line JSON output)
        id: mk
        run: |
          python - << 'PY'
          import json, os

          # Languages supported by Fix GitHub Action: java,csharp,javascript,python,kotlin,scala,php,go
          # CWEs below are intended for batch-mode usage.
          matrix = {
            "include": [
              {"language":"java","cwe":"80,89,113,117,159,209,331,404,597,611","sbp1":"com/:src/main/java/com/","sbp2":"WEB-INF:src/main/webapp/WEB-INF","sbp3":""},
              {"language":"kotlin","cwe":"80,89,113,117,331,404","sbp1":"com/:src/main/java/com/","sbp2":"","sbp3":""},
              {"language":"scala","cwe":"78,80,117,611","sbp1":"com/:src/main/java/com/","sbp2":"","sbp3":""},
              {"language":"csharp","cwe":"80,89,117,209,316,331,352,404,611","sbp1":"src/:src/","sbp2":"","sbp3":""},
              {"language":"javascript","cwe":"80,89,113,117,209,352,601,611,614","sbp1":"src/:src/","sbp2":"","sbp3":""},
              {"language":"python","cwe":"78,80,89,295,331,757","sbp1":"src/:src/","sbp2":"app/:app/","sbp3":""},
              {"language":"php","cwe":"80,89,117","sbp1":"src/:src/","sbp2":"","sbp3":""},
              {"language":"go","cwe":"73,78,117","sbp1":"src/:src/","sbp2":"","sbp3":""}
            ]
          }

          matrix_str = json.dumps(matrix, separators=(",", ":"))
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"matrix={matrix_str}\n")

          print("Matrix output written.")
          PY
        shell: bash

  veracode_fix_universal:
    needs: [pipeline_scan_and_sarif, build_fix_matrix]
    if: (github.event_name == 'pull_request' || inputs.run_fix == 'true') && needs.build_fix_matrix.outputs.matrix != ''
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.build_fix_matrix.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download scan outputs
        uses: actions/download-artifact@v4
        with:
          name: veracode-pipeline-scan
          path: pipeline_out

      - name: Setup Python (Fix input filtering)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Filter Fix input to language=${{ matrix.language }}
        id: filter
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os

          lang = os.environ["LANG"]
          inp = "pipeline_out/filtered_results.json"
          outp = f"pipeline_out/filtered_results_{lang}.json"

          LANG_EXTS = {
            "java": [".java", ".jsp"],
            "kotlin": [".kt"],
            "scala": [".scala"],
            "csharp": [".cs"],
            "javascript": [".js", ".ts", ".jsx", ".tsx"],
            "python": [".py"],
            "php": [".php"],
            "go": [".go"],
          }

          exts = LANG_EXTS.get(lang, [])
          if not exts:
            raise SystemExit(f"No ext mapping for {lang}")

          def norm(p):
            return (p or "").replace("\\","/").strip()

          def src_path(f):
            src = ((f.get("files") or {}).get("source_file") or {})
            return norm(src.get("file") or src.get("upload_file") or "")

          data = json.load(open(inp, "r", encoding="utf-8"))
          findings = data.get("findings", []) if isinstance(data, dict) else []
          kept = []
          for f in findings:
            if not isinstance(f, dict):
              continue
            p = src_path(f).lower()
            if any(p.endswith(e) for e in exts):
              kept.append(f)

          data2 = dict(data)
          data2["findings"] = kept
          json.dump(data2, open(outp, "w", encoding="utf-8"), indent=2)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as g:
            g.write(f"count={len(kept)}\n")
            g.write(f"file={outp}\n")

          print(f"Filtered for {lang}: {len(kept)} of {len(findings)} findings")
          PY
        env:
          LANG: ${{ matrix.language }}

      - name: Skip Fix when no findings for this language
        if: steps.filter.outputs.count == '0'
        run: |
          echo "No findings for language=${{ matrix.language }}. Skipping Fix."

      - name: Run Veracode Fix (Batch → PR) — language=${{ matrix.language }}
        if: steps.filter.outputs.count != '0'
        continue-on-error: true
        uses: Veracode/veracode-fix@v1.0.4
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          inputFile: ${{ steps.filter.outputs.file }}
          language: ${{ matrix.language }}
          cwe: ${{ matrix.cwe }}
          fixType: batch
          files: all
          prComment: true
          createPR: true
          source_base_path_1: ${{ matrix.sbp1 }}
          source_base_path_2: ${{ matrix.sbp2 }}
          source_base_path_3: ${{ matrix.sbp3 }}
