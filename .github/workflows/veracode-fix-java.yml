name: Veracode Fix (Java) — Pipeline Scan → Fix PR

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (creates target/*.war or target/*.jar)
        run: |
          mvn -q -DskipTests clean package
          ls -la target || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            target/*.war
            target/*.jar

  pipeline_scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: build_artifact

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Veracode Pipeline Scan tool
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Run Veracode Pipeline Scan (ESD enabled for Fix)
        continue-on-error: true
        env:
          VERACODE_API_ID: ${{ secrets.VID }}
          VERACODE_API_KEY: ${{ secrets.VKEY }}
        run: |
          set -euo pipefail

          FILE="$(ls -1 build_artifact/*.war build_artifact/*.jar 2>/dev/null | head -n 1)"
          if [ -z "${FILE:-}" ]; then
            echo "No WAR/JAR found in build_artifact/. Check your Maven build output."
            ls -la build_artifact || true
            exit 1
          fi

          echo "Scanning artifact: $FILE"

          # NOTE: pipeline-scan.jar uses single-dash flags, not --flags
          java -jar pipeline-scan.jar \
            -vid "$VERACODE_API_ID" \
            -vkey "$VERACODE_API_KEY" \
            -f "$FILE" \
            -esd true \
            -jf results.json \
            -fjf filtered_results.json

          echo "Generated:"
          ls -lh results.json filtered_results.json

      - name: Upload pipeline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-pipeline-results
          path: |
            results.json
            filtered_results.json

  veracode_fix:
    needs: pipeline_scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download pipeline results
        uses: actions/download-artifact@v4
        with:
          name: veracode-pipeline-results
          path: veracode_results

      - name: Verify required input exists
        run: |
          set -euo pipefail
          ls -lh veracode_results || true
          test -f veracode_results/filtered_results.json

      - name: Run Veracode Fix (batch + PR)
        uses: veracode/veracode-fix-github-action@v1.0.4
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          inputFile: veracode_results/filtered_results.json
          language: java
          fixType: batch
          files: changed
          prComment: true
          createPR: true
