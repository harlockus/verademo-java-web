name: Veracode Fix (Java) — Pipeline Scan → Fix PR

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (WAR/JAR)
        run: |
          mvn -q -DskipTests clean package
          echo "Build output:"
          ls -lah target || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            target/*.war
            target/*.jar

  pipeline_scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: build_artifact

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Veracode Pipeline Scan
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Run Veracode Pipeline Scan (ESD enabled) — DO NOT FAIL ON FINDINGS
        env:
          VERACODE_API_ID: ${{ secrets.VID }}
          VERACODE_API_KEY: ${{ secrets.VKEY }}
        run: |
          set -euo pipefail

          echo "Contents of build_artifact/:"
          ls -lah build_artifact || true

          FILE="$(ls -1 build_artifact/*.war build_artifact/*.jar 2>/dev/null | head -n 1 || true)"
          if [ -z "${FILE:-}" ]; then
            echo "ERROR: No WAR/JAR found in build_artifact/. Check your Maven build output + upload step."
            exit 1
          fi

          echo "Selected artifact: $FILE"
          ls -lah "$FILE"
          file "$FILE" || true

          echo "Running Pipeline Scan..."
          # IMPORTANT: pipeline-scan.jar exits non-zero when findings exist.
          # We capture the exit code but do not fail the job on it.
          set +e
          java -jar pipeline-scan.jar \
            -vid "$VERACODE_API_ID" \
            -vkey "$VERACODE_API_KEY" \
            -f "$FILE" \
            -esd true \
            -jf results.json \
            -fjf filtered_results.json
          RC=$?
          set -e

          echo "Pipeline Scan exit code: $RC"
          echo "Generated outputs:"
          ls -lah results.json filtered_results.json || true

          # Only fail if required outputs are missing (real failure)
          if [ ! -f results.json ] || [ ! -f filtered_results.json ]; then
            echo "ERROR: Pipeline Scan did not produce results.json / filtered_results.json"
            exit 1
          fi

      - name: Upload pipeline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-pipeline-results
          path: |
            results.json
            filtered_results.json

  veracode_fix:
    needs: pipeline_scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download pipeline results
        uses: actions/download-artifact@v4
        with:
          name: veracode-pipeline-results
          path: veracode_results

      - name: Verify Fix input exists
        run: |
          set -euo pipefail
          ls -lah veracode_results
          test -f veracode_results/filtered_results.json

      - name: Run Veracode Fix (Batch → PR)
        uses: Veracode/veracode-fix@v1.0.4
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          inputFile: veracode_results/filtered_results.json
          language: java
          fixType: batch
          files: all
          prComment: true
          createPR: true
          debug: true

          # IMPORTANT: use Veracode’s documented rewrite formats
          source_base_path_1: "com/:src/main/java/com/"
          source_base_path_2: "WEB-INF:src/main/webapp/WEB-INF"

          # IMPORTANT: Java Fix does NOT support CWE-78. Filter to supported CWEs.
          cwe: "80,89,113"
