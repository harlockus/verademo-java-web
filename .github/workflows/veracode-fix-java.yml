name: Veracode Fix (Java) â€” Pipeline Scan â†’ Fix PR

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (WAR/JAR)
        run: |
          mvn -q -DskipTests clean package
          echo "Build output:"
          ls -lah target || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: |
            target/*.war
            target/*.jar

  pipeline_scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: build_artifact

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Veracode Pipeline Scan
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Run Veracode Pipeline Scan (ESD enabled)
        env:
          VERACODE_API_ID: ${{ secrets.VID }}
          VERACODE_API_KEY: ${{ secrets.VKEY }}
        run: |
          set -euo pipefail

          echo "Artifacts:"
          ls -lah build_artifact || true

          FILE="$(ls -1 build_artifact/*.war build_artifact/*.jar 2>/dev/null | head -n 1 || true)"
          if [ -z "${FILE:-}" ]; then
            echo "ERROR: No WAR/JAR found"
            exit 1
          fi

          echo "Scanning: $FILE"

          java -jar pipeline-scan.jar \
            -vid "$VERACODE_API_ID" \
            -vkey "$VERACODE_API_KEY" \
            -f "$FILE" \
            -esd true \
            -jf results.json \
            -fjf filtered_results.json

          echo "Pipeline outputs:"
          ls -lah results.json filtered_results.json

      - name: Upload pipeline results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-pipeline-results
          path: |
            results.json
            filtered_results.json

  veracode_fix:
    needs: pipeline_scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download pipeline results
        uses: actions/download-artifact@v4
        with:
          name: veracode-pipeline-results
          path: veracode_results

      - name: Verify Fix input
        run: |
          set -euo pipefail
          ls -lah veracode_results
          test -f veracode_results/filtered_results.json

      - name: Run Veracode Fix (Batch â†’ PR)
        uses: veracode/veracode-fix-github-action@v1.0.4
        with:
          vid: ${{ secrets.VID }}
          vkey: ${{ secrets.VKEY }}
          inputFile: veracode_results/filtered_results.json
          language: java
          fixType: batch
          files: all
          prComment: true
          createPR: true

          # ðŸ”‘ REQUIRED PATH REWRITE (THIS FIXES YOUR ERROR)
          source_base_path_1: "WEB-INF/:src/main/webapp/WEB-INF/"
